name: Build & Minify for GitHub Pages

permissions:
  contents: write

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Clean out old minified site files but keep:
      #   - src/     (unminified source)
      #   - tests/   (your dev stuff)
      #   - .github/ (workflow folder)
      #   - CNAME
      #   - README.md
      #   - .git, obviously
      - name: Clean old root files
        run: |
          find . -maxdepth 1 \
            ! -name '.' \
            ! -name '.git' \
            ! -name 'src' \
            ! -name 'tests' \
            ! -name '.github' \
            ! -name 'CNAME' \
            ! -name 'README.md' \
            -exec rm -rf {} +

      # Install tools
      - name: Install minifiers
        run: npm install -g html-minifier-terser clean-css-cli terser

      # Copy unminified source into root
      - name: Copy src â†’ root
        run: cp -r src/* .

      # Minify HTML
      - name: Minify HTML
        run: |
          find . -name "*.html" -not -path "./src/*" -not -path "./tests/*" -exec \
            html-minifier-terser --collapse-whitespace --remove-comments \
            --minify-css true --minify-js true \
            -o {} {} \;

      # Minify CSS
      - name: Minify CSS
        run: |
          find . -name "*.css" -not -path "./src/*" -not -path "./tests/*" -exec \
            sh -c 'cleancss -o "$1" "$1"' _ {} \;

      # Minify JS
      - name: Minify JS
        run: |
          find . -name "*.js" -not -path "./src/*" -not -path "./tests/*" -exec \
            sh -c 'terser "$1" -o "$1" --compress --mangle' _ {} \;

      # Commit the minified site
      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Auto-minified site" || echo "No changes"
          git push
name: Deploy Root Minified Site

permissions:
  contents: write

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install minifiers
        run: npm install -g html-minifier-terser clean-css-cli terser

      # Copy root files to dist, ignoring repo config
      - name: Prepare Build Folder
        run: |
          mkdir dist
          rsync -av . dist/ \
            --exclude dist \
            --exclude .git \
            --exclude .github \
            --exclude .gitignore \
            --exclude README.md \
            --exclude node_modules

      # Minify HTML in dist
      - name: Minify HTML
        run: |
          find dist -name "*.html" -exec \
            html-minifier-terser --collapse-whitespace --remove-comments \
            --minify-css true --minify-js true \
            -o {} {} \;

      # Minify CSS in dist
      - name: Minify CSS
        run: |
          find dist -name "*.css" -exec \
            sh -c 'cleancss -o "$1" "$1"' _ {} \;

      # Minify JS in dist
      - name: Minify JS
        run: |
          find dist -name "*.js" -exec \
            sh -c 'terser "$1" -o "$1" --compress --mangle' _ {} \;

      # Deploy dist folder to web branch
      - name: Deploy
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: web
          folder: dist